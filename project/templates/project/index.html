<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Eventos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Gestión de Eventos</h1>
        
        <!-- Formulario de Creación de Evento -->
        <form id="formCrearEvento">
            <div class="form-group">
                <label for="nombre">Nombre del Evento</label>
                <input type="text" class="form-control" id="nombre" required>
            </div>
            <div class="form-group">
                <label for="fecha">Fecha</label>
                <input type="datetime-local" class="form-control" id="fecha" required>
            </div>
            <div class="form-group">
                <label for="lugar">Lugar</label>
                <input type="text" class="form-control" id="lugar" required>
            </div>
            <div class="form-group">
                <label for="tipo">Tipo de Evento</label>
                <select class="form-control" id="tipo">
                    <option value="concierto">Concierto</option>
                    <option value="conferencia">Conferencia</option>
                </select>
            </div>
            <div id="detalleEvento"></div>
            <button type="submit" class="btn btn-success">Crear Evento</button>
        </form>

        <hr>

        <!-- Tablas para Conciertos y Conferencias -->
        <h2>Conciertos</h2>
        <table class="table table-bordered" id="tablaConciertos">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Lugar</th>
                    <th>Artista</th>
                    <th>Duración</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se llenarán los conciertos -->
            </tbody>
        </table>

        <h2>Conferencias</h2>
        <table class="table table-bordered" id="tablaConferencias">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Lugar</th>
                    <th>Tema</th>
                    <th>Orador</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se llenarán las conferencias -->
            </tbody>
        </table>

        <!-- Modal de Edición de Evento -->
        <div class="modal fade" id="editarModal" tabindex="-1" role="dialog" aria-labelledby="editarModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editarModalLabel">Editar Evento</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="formEditarEvento">
                            <input type="hidden" id="eventoId">
                            <div class="form-group">
                                <label for="nombreEdit">Nombre del Evento</label>
                                <input type="text" class="form-control" id="nombreEdit" required>
                            </div>
                            <div class="form-group">
                                <label for="fechaEdit">Fecha</label>
                                <input type="datetime-local" class="form-control" id="fechaEdit" required>
                            </div>
                            <div class="form-group">
                                <label for="lugarEdit">Lugar</label>
                                <input type="text" class="form-control" id="lugarEdit" required>
                            </div>
                            <div class="form-group">
                                <label for="tipoEdit">Tipo de Evento</label>
                                <select class="form-control" id="tipoEdit">
                                    <option value="concierto">Concierto</option>
                                    <option value="conferencia">Conferencia</option>
                                </select>
                            </div>
                            <div id="detalleEventoEdit"></div>
                            <button type="submit" class="btn btn-primary">Actualizar Evento</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmación de Eliminación -->
        <div class="modal fade" id="confirmarEliminacion" tabindex="-1" role="dialog" aria-labelledby="confirmarEliminacionLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmarEliminacionLabel">Confirmar Eliminación</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar este evento?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" id="confirmarEliminarBtn" class="btn btn-danger">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        $(document).ready(function() {
            let eventoIdActual = null;
        
            // Función para formatear la fecha
            function formatearFecha(fecha) {
                return new Date(fecha).toLocaleString('es-ES');
            }
        
            // Mostrar campos específicos dependiendo del tipo de evento
            function mostrarCamposEspecificos(tipo, esEdicion = false) {
                const contenedor = esEdicion ? '#detalleEventoEdit' : '#detalleEvento';
                $(contenedor).empty();
        
                if (tipo === 'concierto') {
                    $(contenedor).html(`
                        <div class="form-group">
                            <label for="artista${esEdicion ? 'Edit' : ''}">Artista</label>
                            <input type="text" class="form-control" id="artista${esEdicion ? 'Edit' : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="duracion${esEdicion ? 'Edit' : ''}">Duración (minutos)</label>
                            <input type="number" class="form-control" id="duracion${esEdicion ? 'Edit' : ''}" required>
                        </div>
                    `);
                } else if (tipo === 'conferencia') {
                    $(contenedor).html(`
                        <div class="form-group">
                            <label for="tema${esEdicion ? 'Edit' : ''}">Tema</label>
                            <input type="text" class="form-control" id="tema${esEdicion ? 'Edit' : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="orador${esEdicion ? 'Edit' : ''}">Orador</label>
                            <input type="text" class="form-control" id="orador${esEdicion ? 'Edit' : ''}" required>
                        </div>
                    `);
                }
            }
        
            // Cambiar los campos específicos según el tipo de evento
            $('#tipo').change(function() {
                mostrarCamposEspecificos($(this).val());
            });
        
            $('#tipoEdit').change(function() {
                mostrarCamposEspecificos($(this).val(), true);
            });
        
            // Crear evento
            $('#formCrearEvento').submit(function(event) {
                event.preventDefault();
                const evento = {
                    nombre: $('#nombre').val(),
                    fecha: $('#fecha').val(),
                    lugar: $('#lugar').val(),
                    tipo: $('#tipo').val(),
                    artista: $('#artista').val(),
                    duracion: $('#duracion').val(),
                    tema: $('#tema').val(),
                    orador: $('#orador').val()
                };
        
                const url = evento.tipo === 'concierto' ? '/api/conciertos/' : '/api/conferencias/';
        
                // Enviar datos al backend
                $.ajax({
                    url: url,
                    method: 'POST',
                    data: JSON.stringify(evento),
                    contentType: 'application/json',
                    success: function(response) {
                        cargarEventos(); // Recargar eventos después de crear uno nuevo
                        // Limpiar el formulario
                        $('#formCrearEvento')[0].reset(); // Limpia todos los campos del formulario
                        $('#detalleEvento').empty(); // Limpia los campos específicos (como Artista, Duración, Tema, etc.)
                        $('#tipo').val('concierto'); // Restablecer tipo de evento a "concierto" por defecto
                    },
                    error: function() {
                        alert('Error al crear el evento');
                    }
                });
            });
        
            // Cargar eventos
            function cargarEventos() {
                $.ajax({
                    url: '/api/conciertos/',
                    method: 'GET',
                    success: function(conciertos) {
                        $('#tablaConciertos tbody').empty();
                        conciertos.forEach(function(concierto) {
                            const fechaFormateada = formatearFecha(concierto.fecha);
                            $('#tablaConciertos tbody').append(`
                                <tr data-id="${concierto.id}">
                                    <td>${concierto.nombre}</td>
                                    <td>${fechaFormateada}</td>
                                    <td>${concierto.lugar}</td>
                                    <td>${concierto.artista}</td>
                                    <td>${concierto.duracion}</td>
                                    <td>
                                        <button class="btn btn-warning btn-editar" data-id="${concierto.id}">Editar</button>
                                        <button class="btn btn-danger btn-eliminar" data-id="${concierto.id}">Eliminar</button>
                                    </td>
                                </tr>
                            `);
                        });
                    }
                });
        
                $.ajax({
                    url: '/api/conferencias/',
                    method: 'GET',
                    success: function(conferencias) {
                        $('#tablaConferencias tbody').empty();
                        conferencias.forEach(function(conferencia) {
                            const fechaFormateada = formatearFecha(conferencia.fecha);
                            $('#tablaConferencias tbody').append(`
                                <tr data-id="${conferencia.id}">
                                    <td>${conferencia.nombre}</td>
                                    <td>${fechaFormateada}</td>
                                    <td>${conferencia.lugar}</td>
                                    <td>${conferencia.tema}</td>
                                    <td>${conferencia.orador}</td>
                                    <td>
                                        <button class="btn btn-warning btn-editar" data-id="${conferencia.id}">Editar</button>
                                        <button class="btn btn-danger btn-eliminar" data-id="${conferencia.id}">Eliminar</button>
                                    </td>
                                </tr>
                            `);
                        });
                    }
                });
            }
        
            // Eliminar evento
            $(document).on('click', '.btn-eliminar', function() {
                const id = $(this).data('id');
                const tipo = $(this).closest('table').attr('id') === 'tablaConciertos' ? 'concierto' : 'conferencia';
                $('#confirmarEliminacion').modal('show');
                $('#confirmarEliminarBtn').data('id', id).data('tipo', tipo);
            });
        
            // Confirmar eliminación
            $('#confirmarEliminarBtn').click(function() {
                const id = $(this).data('id');
                const tipo = $(this).data('tipo');
                const url = tipo === 'concierto' ? `/api/conciertos/${id}/` : `/api/conferencias/${id}/`;
        
                $.ajax({
                    url: url,
                    method: 'DELETE',
                    success: function() {
                        cargarEventos(); // Recargar eventos después de eliminar
                        $('#confirmarEliminacion').modal('hide');
                    },
                    error: function() {
                        alert('Error al eliminar el evento');
                    }
                });
            });
        
            // Editar evento
            $(document).on('click', '.btn-editar', function() {
                const id = $(this).data('id');
                const tipo = $(this).closest('table').attr('id') === 'tablaConciertos' ? 'concierto' : 'conferencia';
        
                // Cargar el evento para editar
                $.ajax({
                    url: tipo === 'concierto' ? `/api/conciertos/${id}/` : `/api/conferencias/${id}/`,
                    method: 'GET',
                    success: function(evento) {
                        eventoIdActual = evento.id;
                        $('#nombreEdit').val(evento.nombre);
                        $('#fechaEdit').val(evento.fecha);
                        $('#lugarEdit').val(evento.lugar);
                        $('#tipoEdit').val(evento.tipo).change();
                        $('#artistaEdit').val(evento.artista || '');
                        $('#duracionEdit').val(evento.duracion || '');
                        $('#temaEdit').val(evento.tema || '');
                        $('#oradorEdit').val(evento.orador || '');
                        $('#editarModal').modal('show');
                    }
                });
            });
        
            // Actualizar evento
            $('#formEditarEvento').submit(function(event) {
                event.preventDefault();
                const evento = {
                    nombre: $('#nombreEdit').val(),
                    fecha: $('#fechaEdit').val(),
                    lugar: $('#lugarEdit').val(),
                    tipo: $('#tipoEdit').val(),
                    artista: $('#artistaEdit').val(),
                    duracion: $('#duracionEdit').val(),
                    tema: $('#temaEdit').val(),
                    orador: $('#oradorEdit').val()
                };
        
                const url = evento.tipo === 'concierto' ? `/api/conciertos/${eventoIdActual}/` : `/api/conferencias/${eventoIdActual}/`;
        
                $.ajax({
                    url: url,
                    method: 'PUT',
                    data: JSON.stringify(evento),
                    contentType: 'application/json',
                    success: function(response) {
                        cargarEventos(); // Recargar eventos después de actualizar uno
                        $('#editarModal').modal('hide');
                    },
                    error: function() {
                        alert('Error al actualizar el evento');
                    }
                });
            });

            // Inicializar carga de eventos
            cargarEventos();
        });
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
